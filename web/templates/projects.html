{% extends "base.html" %}

{% block title %}Project Preview - Respondent Pro{% endblock %}

{% block extra_css %}
<style>
    .header {
        padding: 16px 24px;
        border-bottom: 1px solid var(--border-color);
        border-radius: 0;
        margin-bottom: 0;
        box-shadow: none;
    }
    
    .btn-hide-project {
        padding: 6px 12px;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        color: var(--text-primary);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        transition: all 0.2s;
    }
    
    .btn-hide-project:hover {
        background: var(--hover-bg);
        border-color: var(--primary-color);
    }
    
    .progress-spinner {
        border: 3px solid var(--border-color);
        border-top: 3px solid var(--primary-color);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 16px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Toast Notification System */
    .toast-container {
        position: fixed;
        bottom: 60px;
        right: 20px;
        z-index: 10000;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    .toast {
        min-width: 300px;
        max-width: 400px;
        padding: 16px 20px;
        background: var(--card-bg, #ffffff) !important;
        background-color: var(--card-bg, #ffffff) !important;
        opacity: 1 !important;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        gap: 12px;
        animation: slideInRight 0.3s ease-out;
        position: relative;
    }
    
    /* Ensure toast background is solid in dark mode */
    body.dark-mode .toast,
    [data-theme="dark"] .toast {
        background: var(--card-bg, #1f2937) !important;
        background-color: var(--card-bg, #1f2937) !important;
    }
    
    .toast.success {
        border-left: 4px solid #10b981;
    }
    
    .toast.error {
        border-left: 4px solid #ef4444;
    }
    
    .toast.info {
        border-left: 4px solid var(--primary-color);
    }
    
    .toast-icon {
        flex-shrink: 0;
        width: 20px;
        height: 20px;
    }
    
    .toast-content {
        flex: 1;
        font-size: 14px;
        color: var(--text-primary);
    }
    
    .toast-close {
        flex-shrink: 0;
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: all 0.2s;
    }
    
    .toast-close:hover {
        background: var(--hover-bg);
        color: var(--text-primary);
    }
    
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
    
    .toast.hiding {
        animation: slideOutRight 0.3s ease-in forwards;
    }
</style>
{% endblock %}

{% block body %}
<div class="main-content">
    <div class="header">
        <div class="header-left">
            <div class="logo">R</div>
            <div class="header-title">Respondent Pro</div>
        </div>
        <div class="header-right">
            <div class="profile-menu-container">
                <button class="profile-icon-btn" onclick="toggleProfileMenu()" aria-label="Profile menu">
                    <div class="user-avatar">{{ email[0].upper() if email else 'U' }}</div>
                </button>
                <div class="profile-dropdown" id="profileDropdown">
                    <div class="profile-dropdown-header">
                        <div class="profile-dropdown-avatar">{{ email[0].upper() if email else 'U' }}</div>
                        <div class="profile-dropdown-info">
                            <div class="profile-dropdown-name">{{ email }}</div>
                            <div class="profile-dropdown-id" id="profileAccountId">ID: {{ config.profile_id[:8] if config and config.profile_id else 'Not configured' }}</div>
                        </div>
                    </div>
                    <div class="profile-dropdown-divider"></div>
                    <div class="profile-dropdown-item" onclick="openConfigModal(); closeProfileMenu();">
                        <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
                        </svg>
                        <span>Credentials</span>
                    </div>
                    <div class="profile-dropdown-item" onclick="toggleTheme();">
                        <svg id="theme-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16">
                            <path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.166a.75.75 0 00-1.06-1.06l-1.591 1.59a.75.75 0 101.06 1.061l1.591-1.59zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5H21a.75.75 0 01.75.75zM17.834 18.894a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 10-1.061 1.06l1.59 1.591zM12 18a.75.75 0 01.75.75V21a.75.75 0 01-1.5 0v-2.25A.75.75 0 0112 18zM7.758 17.303a.75.75 0 00-1.061-1.06l-1.591 1.59a.75.75 0 001.06 1.061l1.591-1.59zM6 12a.75.75 0 01-.75.75H3a.75.75 0 010-1.5h2.25A.75.75 0 016 12zM6.697 7.757a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 00-1.061 1.06l1.59 1.591z"/>
                        </svg>
                        <span>Dark Mode</span>
                    </div>
                    <div class="profile-dropdown-divider"></div>
                    <a href="/logout" class="profile-dropdown-item profile-dropdown-logout">
                        <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 001 1h12a1 1 0 001-1V4a1 1 0 00-1-1H3zm11 4.414l-4.293 4.293a1 1 0 01-1.414 0L4 8.414V15h10V7.414zM5 6a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
                        </svg>
                        <span>Logout</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    {% if error %}
    <div class="alert-banner" id="alertBanner">
        <div class="alert-content">
            <svg class="alert-icon" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
            </svg>
            <div>
                <strong>Failed to fetch projects</strong>
                <div style="font-size: 12px; margin-top: 4px; opacity: 0.9;">{{ error }}</div>
            </div>
        </div>
        <button class="btn-try-again" onclick="location.reload()">Try Again</button>
    </div>
    {% endif %}
    
    <div class="content-area">
        <div class="section-header">
            <div class="section-actions">
                <button class="btn-filter-settings" onclick="toggleFilterPanel()" id="filterSettingsBtn">
                    <svg fill="currentColor" viewBox="0 0 20 20" style="width: 16px; height: 16px; margin-right: 8px;">
                        <path d="M5 4a1 1 0 00-2 0v7.268a2 2 0 000 3.464V16a1 1 0 102 0v-1.268a2 2 0 000-3.464V4zM11 4a1 1 0 10-2 0v1.268a2 2 0 000 3.464V16a1 1 0 102 0V8.732a2 2 0 000-3.464V4zM16 3a1 1 0 011 1v7.268a2 2 0 010 3.464V16a1 1 0 11-2 0v-1.268a2 2 0 010-3.464V4a1 1 0 011-1z"/>
                    </svg>
                    Hide Settings
                </button>
            </div>
        </div>
        
        <div class="filter-panel" id="filterPanel" style="display: none;">
            <div class="filter-panel-header">
                <h3>Hide Settings</h3>
                <button class="btn-close-filter" onclick="toggleFilterPanel()">×</button>
            </div>
            <div class="filter-panel-content">
                <!-- Global Mode Selector -->
                <div class="filter-mode-section">
                    <div class="mode-selector-header">
                        <label>Auto Hide:</label>
                        <div class="filter-mode-toggle">
                            <span class="mode-label">Manual</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="globalAutoMode" onchange="updateGlobalMode()">
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="mode-label">Auto</span>
                        </div>
                    </div>
                    <div class="mode-description" id="modeDescription">
                        <p><strong>Manual Mode:</strong> Configure your hide settings below and click "Hide Projects" to hide projects that don't match your criteria.</p>
                    </div>
                </div>
                
                <div class="filter-divider"></div>
                
                <!-- Filter Options -->
                <div class="filter-group">
                    <label for="minIncentive">Hide projects with incentive less than:</label>
                    <div class="filter-input-group">
                        <span class="currency-symbol">$</span>
                        <input type="number" id="minIncentive" placeholder="e.g., 70" min="0" step="0.01">
                        <button class="btn-clear-filter" onclick="clearFilter('minIncentive')" title="Clear filter">×</button>
                    </div>
                    <div class="help-text">Leave empty to keep all projects</div>
                </div>
                
                <div class="filter-group">
                    <label for="minHourlyRate">Hide projects with hourly rate less than:</label>
                    <div class="filter-input-group">
                        <span class="currency-symbol">$</span>
                        <input type="number" id="minHourlyRate" placeholder="e.g., 80" min="0" step="0.01">
                        <button class="btn-clear-filter" onclick="clearFilter('minHourlyRate')" title="Clear filter">×</button>
                    </div>
                    <div class="help-text">Leave empty to keep all projects</div>
                </div>
                
                <div class="filter-group">
                    <div class="filter-header-inline">
                        <label>Remote:</label>
                        <button type="button" class="btn-clear-research-types" onclick="clearRemoteFilter()" title="Clear selection">Clear</button>
                    </div>
                    <div class="research-type-options">
                        <label class="research-type-option">
                            <input type="radio" name="isRemote" id="isRemoteAny" value="null" checked>
                            <span class="option-label">Any</span>
                        </label>
                        <label class="research-type-option">
                            <input type="radio" name="isRemote" id="isRemoteOnly" value="true">
                            <span class="option-label">Remote Only</span>
                        </label>
                    </div>
                    <div class="help-text">Select "Any" to show all projects, or "Remote Only" to show only remote projects (hide non-remote projects).</div>
                </div>
                
                <div class="filter-group">
                    <div class="filter-header-inline">
                        <label>Hide projects with these topics:</label>
                        <button type="button" class="btn-clear-research-types" onclick="clearTopics()" title="Clear all selections">Clear</button>
                    </div>
                    <div class="topics-options" id="topicsOptions" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 6px; padding: 8px;">
                        <div style="text-align: center; padding: 20px; color: var(--text-secondary);">Loading topics...</div>
                    </div>
                    <div class="help-text">Select topics to hide projects that contain them. Leave all unselected to show all projects.</div>
                </div>
                
                <div class="filter-group">
                    <div class="filter-header-inline">
                        <label>Hide projects using AI (based on what we know about you):</label>
                        <button type="button" class="btn-link" onclick="openFeedbackManagementModal()" style="font-size: 0.9em; color: var(--primary-color); text-decoration: underline; background: none; border: none; cursor: pointer; padding: 0; margin-left: 8px;">Manage feedback</button>
                    </div>
                    <div class="research-type-options">
                        <label class="research-type-option">
                            <input type="checkbox" id="hideUsingAI" value="true">
                            <span class="option-label">Enable AI-based hiding</span>
                        </label>
                    </div>
                    <div class="help-text">When enabled, projects will be hidden based on feedback you've provided when hiding previous projects.</div>
                </div>
                
                <div class="filter-panel-actions">
                    <button class="btn-primary" id="applyFiltersBtn" onclick="saveFilters()">Hide Projects</button>
                </div>
            </div>
        </div>
        
        <div class="projects-container">
            {% if not has_config %}
            <div class="empty-state">
                <svg class="empty-state-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
                <h3>Session keys not configured</h3>
                <p>Click the button below to configure your Respondent.io session keys.</p>
                <button class="btn-primary" onclick="openConfigModal()" style="margin-top: 16px;">Configure Session Keys</button>
            </div>
            {% elif projects and projects.results %}
            <div class="project-list">
                {% for project in projects.results %}
                <div class="project-card" data-project-id="{{ project.id }}">
                    <div class="project-header">
                        <div>
                            <div class="project-title">{{ project.name or 'Untitled Project' }}</div>
                            <div class="project-id">ID: {{ project.id }}</div>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <button class="btn-hide-project" onclick="openHideModal('{{ project.id }}', '{{ project.name|replace("'", "\\'") }}')" title="Hide this project">
                                <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.473-1.473A20.932 20.932 0 0018.928 10c-1.137-4.5-4.663-7.857-8.928-9.5a19.04 19.04 0 00-2.348.637L3.707 2.293zM5.865 4.637A18.97 18.97 0 0010 3.5c2.209 0 4.154.89 5.635 2.363A18.97 18.97 0 0116.5 10c0 .695-.08 1.37-.23 2.02l-1.523-1.523A10.945 10.945 0 0015 10a8 8 0 00-8-8c-.695 0-1.37.08-2.02.23L2.293 2.293zm8.293 8.293l-1.586-1.586A4 4 0 0110 6a4 4 0 00-4 4c0 .695.08 1.37.23 2.02l1.523 1.523A10.945 10.945 0 005 10a8 8 0 018-8c.695 0 1.37.08 2.02.23l-1.523 1.523z" clip-rule="evenodd"/>
                                    <path d="M13.586 13.586L2.293 2.293a1 1 0 011.414-1.414l11.293 11.293a1 1 0 01-1.414 1.414z"/>
                                </svg>
                                Hide
                            </button>
                            <a href="https://app.respondent.io/respondents/v2/projects/view/{{ project.id }}" 
                               target="_blank" 
                               class="project-link">
                                <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor" style="margin-right: 6px; vertical-align: middle;">
                                    <path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z"/>
                                    <path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z"/>
                                </svg>
                                Apply
                            </a>
                        </div>
                    </div>
                    
                    <div class="project-meta">
                        {% set remuneration = project.respondentRemuneration or 0 %}
                        {% set time_minutes = project.timeMinutesRequired or 0 %}
                        {% if time_minutes > 0 %}
                            {% set hourly_rate = (remuneration / time_minutes) * 60 %}
                        {% else %}
                            {% set hourly_rate = 0 %}
                        {% endif %}
                        
                        <div class="meta-item">
                            <span class="meta-label">Hourly Rate</span>
                            <span class="meta-value hourly-rate">${{ "%.2f"|format(hourly_rate) }}/hr</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Incentive</span>
                            <span class="meta-value">${{ remuneration }}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Time Required</span>
                            <span class="meta-value">{{ time_minutes }} min</span>
                        </div>
                        {% set project_is_remote = project.isRemote %}
                        {% if project_is_remote is none and project.project %}
                            {% set project_is_remote = project.project.isRemote %}
                        {% endif %}
                        {% set kind_of_research_formatted = project.kindOfResearchFormatted %}
                        {% if kind_of_research_formatted is none and project.project %}
                            {% set kind_of_research_formatted = project.project.kindOfResearchFormatted %}
                        {% endif %}
                        {% if kind_of_research_formatted %}
                        <div class="meta-item">
                            <span class="meta-label">Research Type</span>
                            <span class="meta-value">{{ kind_of_research_formatted }}</span>
                        </div>
                        {% elif project.kindOfResearch %}
                        <div class="meta-item">
                            <span class="meta-label">Research Type</span>
                            <span class="meta-value">
                                {% if project.kindOfResearch == 1 %}Remote
                                {% elif project.kindOfResearch == 2 %}Focus Groups
                                {% elif project.kindOfResearch == 8 %}In-Person
                                {% else %}{{ project.kindOfResearch }}{% endif %}
                            </span>
                        </div>
                        {% endif %}
                        {% if project_is_remote is not none %}
                        <div class="meta-item">
                            <span class="meta-label">Remote</span>
                            <span class="meta-value">{{ 'Yes' if project_is_remote else 'No' }}</span>
                        </div>
                        {% endif %}
                        {% set screener_length = project.screenerQuestionsLength %}
                        {% if screener_length %}
                        <div class="meta-item">
                            <span class="meta-label">Screener Questions</span>
                            <span class="meta-value">{{ screener_length }}</span>
                        </div>
                        {% endif %}
                    </div>
                    
                    {% set project_topics = project.topics %}
                    {% if project_topics is none and project.project %}
                        {% set project_topics = project.project.topics %}
                    {% endif %}
                    {% if project_topics and project_topics|length > 0 %}
                    <div class="project-topics" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                        <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px; font-weight: 500;">Topics:</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                            {% for topic in project_topics %}
                            <span style="display: inline-block; padding: 4px 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.85em; color: var(--text-primary);">
                                {{ topic.name }}
                            </span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if project.description %}
                    <div class="project-description">
                        {{ project.description[:300] }}{% if project.description|length > 300 %}...{% endif %}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <svg class="empty-state-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
                <h3>No projects match your criteria</h3>
                <p>Try changing your Target Hourly Rate or targeting profile.</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <div class="footer">
        <div class="footer-left">
            <div class="hide-progress" id="hideProgress" style="display: none;">
                <div class="progress-spinner"></div>
                <span>Hiding projects... <strong id="progressCurrent">0</strong>/<strong id="progressTotal">0</strong></span>
            </div>
        </div>
        <div class="footer-right">
            <div class="footer-stat" id="footerSyncStatus" style="display: none;">
                <span>Synced <span id="footerSyncTime"></span> • Next refresh in <span id="footerCountdown"></span></span>
            </div>
            <div class="footer-stat">
                <button onclick="refreshCache()" id="footerRefreshCacheBtn" style="background: none; border: none; padding: 4px; cursor: pointer; display: flex; align-items: center; color: var(--text-secondary); transition: color 0.2s;" title="Refresh project cache manually" onmouseover="this.style.color='var(--text-primary)'" onmouseout="this.style.color='var(--text-secondary)'">
                    <svg fill="currentColor" viewBox="0 0 20 20" style="width: 16px; height: 16px;">
                        <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
                    </svg>
                </button>
            </div>
            <div class="footer-stat">
                <span class="connection-badge" id="footerConnectionStatus">{% if has_config %}Connected{% else %}Inactive{% endif %}</span>
            </div>
            <div class="footer-stat" title="Total number of projects hidden by Respondent Pro based on your hide settings (minimum incentive, hourly rate, or research type)">
                <div class="status-dot orange"></div>
                <span><strong id="hiddenCount">{{ hidden_count }}</strong> Hidden</span>
            </div>
            {% if total_projects_count is defined and total_projects_count > 0 %}
            <div class="footer-stat" title="Total number of projects">
                <span><strong id="totalProjectsCount">{{ total_projects_count }}</strong> Projects</span>
            </div>
            {% else %}
            <div class="footer-stat" title="Total number of projects" style="display: none;">
                <span><strong id="totalProjectsCount">0</strong> Projects</span>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Session Keys Configuration Modal -->
<div class="modal-overlay" id="configModal" style="display: {% if show_config_modal %}flex{% else %}none{% endif %};">
    <div class="modal-content">
        <div class="modal-header">
            <h2>
                Session Keys Configuration
            </h2>
            <button class="btn-close-modal" onclick="closeConfigModal()" aria-label="Close">×</button>
        </div>
        
        <div class="modal-body">
            <div class="error" id="configError"></div>
            <div class="success" id="configSuccess"></div>
            
            <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 14px;">
                Provide your Respondent.io session keys to enable API access. You can find these in your browser's Developer Tools (F12) → Network tab when logged into respondent.io.
            </p>
            
            <form id="sessionKeysForm">
                <div class="form-group">
                    <label for="modal_session_sid">respondent.session.sid *</label>
                    <input type="text" id="modal_session_sid" placeholder="s%3AvDYrxyRM_m854jqPq90t05fkyVodoUc-..." name="session_sid" required>
                    <div class="help-text">The session cookie value from your browser</div>
                </div>
                
                <div class="form-group">
                    <label for="modal_authorization">Authorization Header</label>
                    <input type="text" id="modal_authorization" placeholder="Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." name="authorization">
                    <div class="help-text">The Authorization Bearer token from request headers (optional)</div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeConfigModal()">Cancel</button>
                    <button type="submit" class="btn-primary" id="modalSaveBtn">Save Session Keys</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Hide Project Feedback Modal -->
<div class="modal-overlay" id="hideModal" style="display: none;">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h2>Hide Project</h2>
            <button class="btn-close-modal" onclick="closeHideModal()" aria-label="Close">×</button>
        </div>
        <div class="modal-body">
            <!-- Project Preview -->
            <div id="hideProjectPreview" style="margin-bottom: 24px; padding: 16px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-color);">
                <div id="hideProjectPreviewLoading" style="text-align: center; padding: 20px;">
                    <div class="progress-spinner"></div>
                    <p>Loading project details...</p>
                </div>
                <div id="hideProjectPreviewContent" style="display: none;">
                    <h3 id="hideProjectName" style="margin: 0 0 12px 0; font-size: 18px;"></h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 12px; font-size: 14px;">
                        <div>
                            <span style="color: var(--text-secondary);">Incentive:</span>
                            <strong id="hideProjectIncentive" style="margin-left: 8px;"></strong>
                        </div>
                        <div>
                            <span style="color: var(--text-secondary);">Time:</span>
                            <strong id="hideProjectTime" style="margin-left: 8px;"></strong>
                        </div>
                        <div>
                            <span style="color: var(--text-secondary);">Hourly Rate:</span>
                            <strong id="hideProjectHourlyRate" style="margin-left: 8px;"></strong>
                        </div>
                        <div id="hideProjectTopicsContainer" style="display: none;">
                            <span style="color: var(--text-secondary);">Topics:</span>
                            <div id="hideProjectTopics" style="display: inline-flex; flex-wrap: wrap; gap: 4px; margin-left: 8px;"></div>
                        </div>
                    </div>
                    <div id="hideProjectDescription" style="font-size: 14px; color: var(--text-secondary); line-height: 1.5; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);"></div>
                </div>
            </div>
            
            <!-- AI Suggestions -->
            <div id="hideSuggestionsContainer" style="margin-bottom: 16px;">
                <p style="margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Suggested reasons to hide:</p>
                <div id="hideSuggestions" style="display: flex; flex-wrap: wrap; gap: 8px;">
                    <!-- Suggestions will be populated here -->
                </div>
            </div>
            
            <!-- Feedback Textarea -->
            <div style="margin-bottom: 16px;">
                <p style="margin-bottom: 8px; font-weight: 500;">Why are you hiding this project? (optional)</p>
                <textarea id="hideFeedbackText" placeholder="Type your reason or click a suggestion above..." rows="3" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; font-family: inherit; resize: vertical;"></textarea>
            </div>
            
            <div class="modal-actions" style="margin-top: 16px;">
                <button type="button" class="btn-secondary" onclick="closeHideModal()">Cancel</button>
                <button type="button" class="btn-secondary" onclick="hideProjectWithoutFeedback()">Hide without feedback</button>
                <button type="button" class="btn-primary" onclick="hideProjectWithFeedback()">Hide</button>
            </div>
        </div>
    </div>
</div>

<!-- Feedback Management Modal -->
<div class="modal-overlay" id="feedbackManagementModal" style="display: none;">
    <div class="modal-content" style="max-width: 800px; max-height: 80vh; display: flex; flex-direction: column;">
        <div class="modal-header">
            <h2>Manage Hide Feedback</h2>
            <button class="btn-close-modal" onclick="closeFeedbackManagementModal()" aria-label="Close">×</button>
        </div>
        <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 20px;">
            <div id="feedbackLoading" style="text-align: center; padding: 40px;">
                <div class="progress-spinner"></div>
                <p>Loading feedback...</p>
            </div>
            <div id="feedbackContent" style="display: none;">
                <div id="feedbackList" style="display: flex; flex-direction: column; gap: 10px;">
                    <!-- Feedback entries will be populated here -->
                </div>
                <div id="feedbackEmpty" style="text-align: center; padding: 40px; color: var(--text-secondary); display: none;">
                    <p>No feedback entries yet. Feedback is collected when you hide projects and provide a reason.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preview Hide Projects Modal -->
<div class="modal-overlay" id="previewHideModal" style="display: none;" onclick="if(event.target === this) closePreviewHideModal();">
    <div class="modal-content" style="max-width: 900px; max-height: 80vh; display: flex; flex-direction: column;" onclick="event.stopPropagation();">
        <div class="modal-header">
            <h2>Preview Projects to Hide</h2>
            <button class="btn-close-modal" onclick="closePreviewHideModal()" aria-label="Close">×</button>
        </div>
        <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 20px;">
            <div id="previewHideLoading" style="text-align: center; padding: 40px;">
                <div class="progress-spinner"></div>
                <p id="previewHideLoadingText">Loading preview...</p>
                <p id="previewHideProgressText" style="margin-top: 12px; font-size: 0.9em; color: var(--text-secondary);"></p>
            </div>
            <div id="previewHideContent" style="display: none;">
                <p style="margin-bottom: 16px; color: var(--text-secondary);">
                    <strong id="previewHideCount">0</strong> project(s) will be hidden based on your current filter settings.
                </p>
                <div style="padding: 12px; background: var(--error-bg); border: 1px solid var(--error-text); border-radius: 6px; margin-bottom: 16px; color: var(--error-text);">
                    <p style="margin: 0;"><strong>⚠️ Warning:</strong> When you confirm, these projects will be permanently hidden via Respondent.io and this action cannot be undone.</p>
                </div>
                <div id="previewHideProjectsList" style="display: grid; gap: 12px;">
                    <!-- Projects will be populated here -->
                </div>
            </div>
            <div id="previewHideEmpty" style="display: none; text-align: center; padding: 40px; color: var(--text-secondary);">
                <p>No projects match your filter criteria. Nothing will be hidden.</p>
            </div>
            <div id="previewHideError" style="display: none; text-align: center; padding: 40px; color: var(--error-text);">
                <p id="previewHideErrorMessage">An error occurred while loading the preview.</p>
            </div>
        </div>
        <div class="modal-actions" style="padding: 16px 20px; border-top: 1px solid var(--border-color);">
            <button type="button" class="btn-secondary" onclick="closePreviewHideModal()">Cancel</button>
            <button type="button" class="btn-primary" id="confirmHideBtn" onclick="confirmHideProjects(event)" disabled>Confirm & Hide Projects</button>
        </div>
    </div>
</div>

<!-- Question Modal -->
<div class="modal-overlay" id="questionModal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h2>Help Us Learn Your Preferences</h2>
            <button class="btn-close-modal" onclick="closeQuestionModal()" aria-label="Close">×</button>
        </div>
        <div class="modal-body">
            <p id="questionText" style="margin-bottom: 24px; font-size: 16px; line-height: 1.5;"></p>
            <div class="modal-actions" style="display: flex; gap: 12px; justify-content: flex-end;">
                <button type="button" class="btn-secondary" onclick="skipQuestion()">Skip</button>
                <button type="button" class="btn-secondary" onclick="answerQuestion(false)">No</button>
                <button type="button" class="btn-primary" onclick="answerQuestion(true)">Yes</button>
            </div>
        </div>
    </div>
</div>


<!-- Toast Notification Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Analytics Section -->
<div class="analytics-section" id="analyticsSection" style="display: none; margin-top: 24px; padding: 20px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color);">
    <h3 style="margin-bottom: 16px;">Hidden Projects Analytics</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div>
            <h4 style="margin-bottom: 12px;">Timeline</h4>
            <canvas id="hiddenProjectsChart" width="400" height="200"></canvas>
        </div>
        <div>
            <h4 style="margin-bottom: 12px;">Breakdown by Method</h4>
            <div id="methodBreakdown"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Toast Notification System
    function showToast(message, type = 'info', duration = 5000) {
        const container = document.getElementById('toastContainer');
        if (!container) return;
        
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        const iconSvg = type === 'success' 
            ? '<svg class="toast-icon" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>'
            : type === 'error'
            ? '<svg class="toast-icon" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/></svg>'
            : '<svg class="toast-icon" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/></svg>';
        
        toast.innerHTML = `
            ${iconSvg}
            <div class="toast-content">${message}</div>
            <button class="toast-close" onclick="this.parentElement.remove()" aria-label="Close">
                <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                </svg>
            </button>
        `;
        
        container.appendChild(toast);
        
        // Auto-remove after duration
        if (duration > 0) {
            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }
    }
    
    // Modal functions
    function openConfigModal() {
        document.getElementById('configModal').style.display = 'flex';
        // Load existing config if available
        {% if config %}
        const config = {{ config | tojson }};
        if (config.cookies && config.cookies['respondent.session.sid']) {
            document.getElementById('modal_session_sid').value = config.cookies['respondent.session.sid'];
        }
        if (config.authorization) {
            document.getElementById('modal_authorization').value = config.authorization;
        }
        {% endif %}
    }
    
    function closeConfigModal() {
        document.getElementById('configModal').style.display = 'none';
        hideConfigMessage();
    }
    
    // Close modal when clicking outside
    document.getElementById('configModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeConfigModal();
        }
    });
    
    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeConfigModal();
        }
    });
    
    function showConfigError(message) {
        const errorEl = document.getElementById('configError');
        errorEl.textContent = message;
        errorEl.classList.add('show');
        document.getElementById('configSuccess').classList.remove('show');
    }
    
    function showConfigSuccess(message) {
        const successEl = document.getElementById('configSuccess');
        successEl.textContent = message;
        successEl.classList.add('show');
        document.getElementById('configError').classList.remove('show');
    }
    
    function hideConfigMessage() {
        document.getElementById('configError').classList.remove('show');
        document.getElementById('configSuccess').classList.remove('show');
    }
    
    // Handle session keys form submission
    document.getElementById('sessionKeysForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        hideConfigMessage();
        
        const session_sid = document.getElementById('modal_session_sid').value.trim();
        const authorization = document.getElementById('modal_authorization').value.trim() || null;
        
        if (!session_sid) {
            showConfigError('respondent.session.sid is required');
            return;
        }
        
        const saveBtn = document.getElementById('modalSaveBtn');
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';
        
        try {
            const response = await fetch('/api/session-keys', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    session_sid,
                    authorization
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to save session keys');
            }
            
            const result = await response.json();
            
            // Display verification results
            if (result.verification) {
                const verification = result.verification;
                if (verification.success) {
                    showConfigSuccess(
                        `✅ ${result.message}\n` +
                        `✅ Authentication verified!\n` +
                        `Profile ID: ${verification.profile_id}\n` +
                        `First Name: ${verification.first_name}`
                    );
                    
                    // Reload page after a short delay to show projects
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } else {
                    showConfigError(
                        `Session keys saved, but verification failed:\n${verification.message}`
                    );
                }
            } else {
                showConfigSuccess(result.message || 'Session keys saved successfully!');
                setTimeout(() => {
                    location.reload();
                }, 1500);
            }
            
        } catch (error) {
            showConfigError(error.message || 'Failed to save session keys');
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save Session Keys';
        }
    });
    
    // Load saved hide settings on page load
    window.addEventListener('DOMContentLoaded', () => {
        // Initialize all settings to empty/unchecked by default
        document.getElementById('minIncentive').value = '';
        document.getElementById('minHourlyRate').value = '';
        document.getElementById('globalAutoMode').checked = false;
        document.getElementById('isRemoteAny').checked = true;
        document.getElementById('isRemoteOnly').checked = false;
        
        // Load saved filters if they exist
        {% if filters %}
        const filters = {{ filters | tojson }};
        
        if (filters.min_incentive !== null && filters.min_incentive !== undefined) {
            document.getElementById('minIncentive').value = filters.min_incentive;
        }
        
        if (filters.min_hourly_rate !== null && filters.min_hourly_rate !== undefined) {
            document.getElementById('minHourlyRate').value = filters.min_hourly_rate;
        }
        
        // Load remote filter
        if (filters.isRemote === true) {
            document.getElementById('isRemoteOnly').checked = true;
            document.getElementById('isRemoteAny').checked = false;
        } else {
            document.getElementById('isRemoteAny').checked = true;
            document.getElementById('isRemoteOnly').checked = false;
        }
        
        // Load topics filter (after topics are loaded)
        loadTopics().then(() => {
            {% if filters %}
            const filters = {{ filters | tojson }};
            if (filters.topics && Array.isArray(filters.topics) && filters.topics.length > 0) {
                filters.topics.forEach(topicId => {
                    const checkbox = document.getElementById('topic' + topicId.replace(/[^a-zA-Z0-9]/g, '_'));
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
            }
            {% endif %}
        });
        
        // Set global auto mode (check if any filter is in auto mode)
        const isAutoMode = filters.auto_hide || false;
        if (isAutoMode) {
            document.getElementById('globalAutoMode').checked = true;
        }
        
        // Set AI hide flag
        const hideUsingAI = filters.hide_using_ai || false;
        if (hideUsingAI) {
            document.getElementById('hideUsingAI').checked = true;
        }
        {% endif %}
        
        updateGlobalMode();
    });
    
    function toggleFilterPanel() {
        const panel = document.getElementById('filterPanel');
        const isVisible = panel.style.display !== 'none';
        panel.style.display = isVisible ? 'none' : 'block';
    }
    
    function updateGlobalMode() {
        const isAuto = document.getElementById('globalAutoMode').checked;
        const modeDescription = document.getElementById('modeDescription');
        const applyBtn = document.getElementById('applyFiltersBtn');
        
        if (isAuto) {
            modeDescription.innerHTML = '<p><strong>Auto Hide:</strong> When enabled, projects will be automatically hidden in the background based on your hide settings, removing the need to manually hide projects.</p>';
            applyBtn.textContent = 'Save & Enable Auto Hide';
        } else {
            modeDescription.innerHTML = '<p><strong>Manual Mode:</strong> Configure your hide settings below and click "Hide Projects" to hide projects that don\'t match your criteria.</p>';
            applyBtn.textContent = 'Hide Projects';
        }
    }
    
    function clearFilter(filterId) {
        document.getElementById(filterId).value = '';
    }
    
    function clearAllFilters() {
        document.getElementById('minIncentive').value = '';
        document.getElementById('minHourlyRate').value = '';
        document.getElementById('globalAutoMode').checked = false;
        
        // Clear remote filter
        document.getElementById('isRemoteAny').checked = true;
        document.getElementById('isRemoteOnly').checked = false;
        
        // Clear topics selection
        document.querySelectorAll('input[id^="topic"]').forEach(checkbox => {
            checkbox.checked = false;
        });
        
        updateGlobalMode();
    }
    
    function clearRemoteFilter() {
        document.getElementById('isRemoteAny').checked = true;
        document.getElementById('isRemoteOnly').checked = false;
    }
    
    function clearTopics() {
        document.querySelectorAll('input[id^="topic"]').forEach(checkbox => {
            checkbox.checked = false;
        });
    }
    
    async function loadTopics() {
        try {
            const response = await fetch('/api/topics');
            if (!response.ok) {
                throw new Error('Failed to load topics');
            }
            const data = await response.json();
            const topics = data.topics || [];
            
            const topicsOptions = document.getElementById('topicsOptions');
            if (topics.length === 0) {
                topicsOptions.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">No topics available yet. Topics will appear after projects are loaded.</div>';
                return;
            }
            
            topicsOptions.innerHTML = '';
            topics.forEach(topic => {
                const label = document.createElement('label');
                label.className = 'research-type-option';
                label.style.cssText = 'display: flex; align-items: center; padding: 8px; cursor: pointer;';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = 'topic' + topic.id.replace(/[^a-zA-Z0-9]/g, '_');
                checkbox.value = topic.id;
                checkbox.style.marginRight = '8px';
                
                const span = document.createElement('span');
                span.className = 'option-label';
                span.textContent = topic.name;
                
                label.appendChild(checkbox);
                label.appendChild(span);
                topicsOptions.appendChild(label);
            });
        } catch (error) {
            console.error('Error loading topics:', error);
            document.getElementById('topicsOptions').innerHTML = '<div style="text-align: center; padding: 20px; color: var(--error-color);">Error loading topics</div>';
        }
    }
    
    // Store pending filters for confirmation
    let pendingFilters = null;
    
    async function saveFilters() {
        const minIncentiveInput = document.getElementById('minIncentive').value.trim();
        const minHourlyRateInput = document.getElementById('minHourlyRate').value.trim();
        const globalAutoMode = document.getElementById('globalAutoMode').checked;
        
        // Get remote filter setting
        const isRemoteOnlyChecked = document.getElementById('isRemoteOnly').checked;
        const isRemote = isRemoteOnlyChecked ? true : null;
        
        // Get selected topics
        const topics = [];
        document.querySelectorAll('input[id^="topic"]:checked').forEach(checkbox => {
            topics.push(checkbox.value);
        });
        
        // Get AI hide flag
        const hideUsingAI = document.getElementById('hideUsingAI').checked;
        
        // Parse numeric values, ensuring they're valid numbers or null
        let minIncentive = null;
        if (minIncentiveInput) {
            const parsed = parseFloat(minIncentiveInput);
            if (!isNaN(parsed) && isFinite(parsed)) {
                minIncentive = parsed;
            }
        }
        
        let minHourlyRate = null;
        if (minHourlyRateInput) {
            const parsed = parseFloat(minHourlyRateInput);
            if (!isNaN(parsed) && isFinite(parsed)) {
                minHourlyRate = parsed;
            }
        }
        
        // Apply global auto mode to all filters
        const filters = {
            min_incentive: minIncentive,
            min_hourly_rate: minHourlyRate,
            isRemote: isRemote,
            auto_hide: globalAutoMode,
            topics: topics,
            hide_using_ai: hideUsingAI
        };
        
        // If auto mode is enabled, save and proceed without preview
        if (globalAutoMode) {
            await proceedWithHide(filters);
            return;
        }
        
        // For manual mode, show preview first
        pendingFilters = filters;
        await showPreviewHideModal(filters);
    }
    
    let previewHideProgressInterval = null;
    
    async function showPreviewHideModal(filters) {
        const modal = document.getElementById('previewHideModal');
        const loading = document.getElementById('previewHideLoading');
        const content = document.getElementById('previewHideContent');
        const empty = document.getElementById('previewHideEmpty');
        const error = document.getElementById('previewHideError');
        const projectsList = document.getElementById('previewHideProjectsList');
        const confirmBtn = document.getElementById('confirmHideBtn');
        const loadingText = document.getElementById('previewHideLoadingText');
        const progressText = document.getElementById('previewHideProgressText');
        
        // Show modal and loading state
        modal.style.display = 'flex';
        loading.style.display = 'block';
        content.style.display = 'none';
        empty.style.display = 'none';
        error.style.display = 'none';
        confirmBtn.disabled = true;
        loadingText.textContent = 'Loading preview...';
        progressText.textContent = '';
        
        // Start polling for progress
        if (previewHideProgressInterval) {
            clearInterval(previewHideProgressInterval);
        }
        previewHideProgressInterval = setInterval(async () => {
            try {
                const progressResponse = await fetch('/api/preview-hide-progress');
                if (progressResponse.ok) {
                    const progress = await progressResponse.json();
                    if (progress.status === 'processing') {
                        if (progress.total > 0) {
                            const percentage = Math.round((progress.current / progress.total) * 100);
                            loadingText.textContent = `Processing projects...`;
                            progressText.textContent = `Processed ${progress.current} of ${progress.total} projects (${percentage}%)`;
                            if (progress.matched > 0) {
                                progressText.textContent += ` • ${progress.matched} match(es) found`;
                            }
                        } else {
                            loadingText.textContent = 'Preparing to process...';
                            progressText.textContent = '';
                        }
                    } else if (progress.status === 'completed' || progress.status === 'error') {
                        clearInterval(previewHideProgressInterval);
                        previewHideProgressInterval = null;
                    }
                }
            } catch (e) {
                // Ignore progress polling errors
                console.debug('Progress polling error:', e);
            }
        }, 200); // Poll every 200ms for smooth updates
        
        try {
            const response = await fetch('/api/preview-hide', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(filters)
            });
            
            // Stop polling
            if (previewHideProgressInterval) {
                clearInterval(previewHideProgressInterval);
                previewHideProgressInterval = null;
            }
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to load preview');
            }
            
            const result = await response.json();
            loading.style.display = 'none';
            
            if (result.count === 0) {
                empty.style.display = 'block';
                confirmBtn.disabled = true;
            } else {
                content.style.display = 'block';
                document.getElementById('previewHideCount').textContent = result.count;
                
                // Clear previous projects
                projectsList.innerHTML = '';
                
                // Display projects
                result.projects.forEach(project => {
                    const projectCard = document.createElement('div');
                    projectCard.style.cssText = 'padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-secondary);';
                    projectCard.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: start; gap: 12px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">${escapeHtml(project.name)}</div>
                                <div style="display: flex; gap: 16px; flex-wrap: wrap; font-size: 0.9em; color: var(--text-secondary);">
                                    <span><strong>ID:</strong> <a href="https://app.respondent.io/respondents/v2/projects/view/${project.id}" target="_blank" style="color: var(--link-color, #3b82f6); text-decoration: underline;">${project.id}</a></span>
                                    <span><strong>Incentive:</strong> $${project.incentive}</span>
                                    <span><strong>Hourly Rate:</strong> $${project.hourly_rate}/hr</span>
                                    <span><strong>Time:</strong> ${project.time_minutes} min</span>
                                    <span><strong>Remote:</strong> ${project.remote_status || 'Unknown'}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    projectsList.appendChild(projectCard);
                });
                
                confirmBtn.disabled = false;
            }
        } catch (err) {
            // Stop polling on error
            if (previewHideProgressInterval) {
                clearInterval(previewHideProgressInterval);
                previewHideProgressInterval = null;
            }
            loading.style.display = 'none';
            error.style.display = 'block';
            document.getElementById('previewHideErrorMessage').textContent = err.message;
            confirmBtn.disabled = true;
        }
    }
    
    function closePreviewHideModal() {
        // Stop progress polling if active
        if (previewHideProgressInterval) {
            clearInterval(previewHideProgressInterval);
            previewHideProgressInterval = null;
        }
        document.getElementById('previewHideModal').style.display = 'none';
        pendingFilters = null;
    }
    
    async function confirmHideProjects(event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        
        if (!pendingFilters) {
            return;
        }
        
        // Save filters to local variable before closing modal (which clears pendingFilters)
        const filtersToUse = pendingFilters;
        closePreviewHideModal();
        
        try {
            await proceedWithHide(filtersToUse);
        } catch (error) {
            throw error;
        }
        pendingFilters = null;
    }
    
    async function proceedWithHide(filters) {
        try {
            // Save filters first
            const response = await fetch('/api/filters', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(filters)
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to save hide settings');
            }
            
            const result = await response.json();
            if (result.success) {
                showToast('Hide settings saved successfully', 'success');
                
                // Trigger hide process
                try {
                    const hideResponse = await fetch('/api/hide-projects', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (hideResponse.ok) {
                        // Start polling for progress
                        startProgressPolling();
                    } else {
                        // If hide endpoint fails, show error instead of reloading
                        const errorData = await hideResponse.json().catch(() => ({ error: 'Failed to start hide process' }));
                        console.error('Hide endpoint failed:', errorData);
                        showToast('Error starting hide process: ' + (errorData.error || 'Unknown error'), 'error');
                    }
                } catch (error) {
                    console.error('Error starting hide process:', error);
                    showToast('Error starting hide process: ' + error.message, 'error');
                }
            }
        } catch (error) {
            console.error('Error saving hide settings:', error);
            showToast('Error saving hide settings: ' + error.message, 'error');
        }
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    
    function toggleProfileMenu() {
        const dropdown = document.getElementById('profileDropdown');
        if (dropdown) {
            dropdown.classList.toggle('show');
        }
    }
    
    function closeProfileMenu() {
        const dropdown = document.getElementById('profileDropdown');
        if (dropdown) {
            dropdown.classList.remove('show');
        }
    }
    
    // Close profile menu when clicking outside
    document.addEventListener('click', function(event) {
        const profileMenu = document.querySelector('.profile-menu-container');
        const dropdown = document.getElementById('profileDropdown');
        if (profileMenu && dropdown && !profileMenu.contains(event.target)) {
            dropdown.classList.remove('show');
        }
    });
    
    // Close profile menu on Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeProfileMenu();
        }
    });
    
    function updateCacheRefreshedDisplay() {
        // This function can be called after cache refresh
        // For now, we'll reload the page to get the updated cache time
        // In the future, this could fetch the cache stats via API
        const cacheRefreshedEl = document.getElementById('cacheRefreshed');
        if (cacheRefreshedEl) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            cacheRefreshedEl.innerHTML = `• Synced ${timeStr}`;
            cacheRefreshedEl.setAttribute('data-refreshed', timeStr);
            cacheRefreshedEl.style.display = 'inline';
        }
    }
    
    // Get user's timezone (request location permission or use browser timezone)
    let userTimezone = null;
    
    async function detectTimezone() {
        // First, try to get timezone from browser (no permission needed)
        try {
            const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            userTimezone = timezone;
            return timezone;
        } catch (e) {
            console.error('Error getting browser timezone:', e);
        }
        
        // Optionally request location for more accurate timezone
        // (This is optional - browser timezone is usually sufficient)
        if (navigator.geolocation) {
            return new Promise((resolve) => {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        try {
                            // Use a timezone API to get timezone from coordinates
                            const lat = position.coords.latitude;
                            const lon = position.coords.longitude;
                            // For now, use browser timezone as fallback
                            // In production, you could call a timezone API like timezoneapi.io
                            const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                            userTimezone = timezone;
                            resolve(timezone);
                        } catch (e) {
                            // Fallback to browser timezone
                            const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                            userTimezone = timezone;
                            resolve(timezone);
                        }
                    },
                    (error) => {
                        // User denied location or error - use browser timezone
                        console.log('Location access denied or error, using browser timezone');
                        const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                        userTimezone = timezone;
                        resolve(timezone);
                    },
                    { timeout: 5000, enableHighAccuracy: false }
                );
            });
        } else {
            // No geolocation support - use browser timezone
            const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            userTimezone = timezone;
            return timezone;
        }
    }
    
    // Convert UTC timestamp to local timezone and format
    function formatLocalTime(utcTimestamp) {
        if (!utcTimestamp) return null;
        
        try {
            const utcDate = new Date(utcTimestamp);
            if (isNaN(utcDate.getTime())) {
                console.error('Invalid UTC timestamp:', utcTimestamp);
                return null;
            }
            
            // Format in user's local timezone
            const timeStr = utcDate.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true,
                timeZone: userTimezone || undefined
            });
            
            return timeStr;
        } catch (e) {
            console.error('Error formatting local time:', e);
            return null;
        }
    }
    
    // Update cache refresh time display
    function updateCacheRefreshDisplay(utcTimestamp) {
        if (!utcTimestamp) return;
        
        const localTime = formatLocalTime(utcTimestamp);
        if (localTime) {
            // Update footer sync time
            const footerSyncTimeEl = document.getElementById('footerSyncTime');
            const footerSyncStatusEl = document.getElementById('footerSyncStatus');
            if (footerSyncTimeEl) {
                footerSyncTimeEl.textContent = localTime;
            }
            if (footerSyncStatusEl) {
                footerSyncStatusEl.style.display = 'block';
            }
            
            // Update countdown timer
            updateCountdownTimer(utcTimestamp);
        }
    }
    
    // Update countdown timer
    function updateCountdownTimer(utcTimestamp) {
        if (!utcTimestamp) return;
        
        const countdownEl = document.getElementById('footerCountdown');
        if (!countdownEl) return;
        
        try {
            const lastUpdated = new Date(utcTimestamp);
            const nextRefresh = new Date(lastUpdated.getTime() + 24 * 60 * 60 * 1000); // Add 24 hours
            const now = new Date();
            const diff = nextRefresh - now;
            
            if (diff <= 0) {
                countdownEl.textContent = 'Refreshing...';
                return;
            }
            
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            if (hours > 0) {
                countdownEl.textContent = `${hours}h ${minutes}m`;
            } else if (minutes > 0) {
                countdownEl.textContent = `${minutes}m ${seconds}s`;
            } else {
                countdownEl.textContent = `${seconds}s`;
            }
        } catch (e) {
            console.error('Error updating countdown timer:', e);
            countdownEl.textContent = '--';
        }
    }
    
    // Start countdown timer interval
    let countdownInterval = null;
    function startCountdownTimer(utcTimestamp) {
        if (countdownInterval) {
            clearInterval(countdownInterval);
        }
        
        // Update immediately
        updateCountdownTimer(utcTimestamp);
        
        // Update every second
        countdownInterval = setInterval(() => {
            updateCountdownTimer(utcTimestamp);
        }, 1000);
    }
    
    // Update cache refresh time after projects are fetched
    async function updateCacheRefreshTime() {
        try {
            // First ensure timezone is detected
            if (!userTimezone) {
                await detectTimezone();
            }
            
            const response = await fetch('/api/cache/stats');
            if (response.ok) {
                const data = await response.json();
                const utcTimestamp = data.last_updated || data.cache_refreshed_str;
                if (utcTimestamp) {
                    updateCacheRefreshDisplay(utcTimestamp);
                    startCountdownTimer(utcTimestamp);
                }
            }
        } catch (error) {
            console.error('Error updating cache refresh time:', error);
        }
    }
    
    // Refresh cache manually
    async function refreshCache() {
        const btn = document.getElementById('footerRefreshCacheBtn');
        if (!btn) return;
        
        const originalSvg = btn.innerHTML;
        btn.disabled = true;
        btn.style.opacity = '0.5';
        btn.innerHTML = '<svg fill="currentColor" viewBox="0 0 20 20" style="width: 16px; height: 16px; animation: spin 1s linear infinite;"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/></svg>';
        
        try {
            const response = await fetch('/api/cache/refresh', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to refresh cache');
            }
            
            const result = await response.json();
            
            // Update cache refresh time display with new UTC timestamp
            if (!userTimezone) {
                await detectTimezone();
            }
            if (result.last_updated) {
                updateCacheRefreshDisplay(result.last_updated);
                startCountdownTimer(result.last_updated);
            } else {
                await updateCacheRefreshTime();
            }
            
            // Show success message
            showToast('Cache refreshed successfully!', 'success');
            
            // Reload page to show updated projects
            location.reload();
        } catch (error) {
            console.error('Error refreshing cache:', error);
            showToast('Error refreshing cache: ' + error.message, 'error');
            btn.innerHTML = originalSvg;
            btn.disabled = false;
            btn.style.opacity = '1';
        }
    }
    
    let progressPollingInterval = null;
    let hasSeenInProgress = false; // Track if we've seen in_progress status
    
    function startProgressPolling() {
        // Reset the flag when starting new polling
        hasSeenInProgress = false;
        
        // Show progress indicator
        const progressEl = document.getElementById('hideProgress');
        if (progressEl) {
            progressEl.style.display = 'flex';
        }
        
        // Start polling
        if (progressPollingInterval) {
            clearInterval(progressPollingInterval);
        }
        
        progressPollingInterval = setInterval(checkHideProgress, 1000); // Poll every second
        checkHideProgress(); // Check immediately
    }
    
    function stopProgressPolling() {
        if (progressPollingInterval) {
            clearInterval(progressPollingInterval);
            progressPollingInterval = null;
        }
    }
    
    async function checkHideProgress() {
        try {
            const response = await fetch('/api/hide-progress');
            if (!response.ok) {
                return;
            }
            
            const progress = await response.json();
            
            // Update progress display
            const progressEl = document.getElementById('hideProgress');
            const currentEl = document.getElementById('progressCurrent');
            const totalEl = document.getElementById('progressTotal');
            
            if (progress.status === 'in_progress') {
                hasSeenInProgress = true; // Mark that we've seen in_progress
                if (progressEl) progressEl.style.display = 'flex';
                if (currentEl) currentEl.textContent = progress.current || 0;
                if (totalEl) totalEl.textContent = progress.total || 0;
            } else if (progress.status === 'completed') {
                // Hide progress indicator
                if (progressEl) progressEl.style.display = 'none';
                stopProgressPolling();
                
                // Update hidden count
                if (progress.hidden !== undefined) {
                    const hiddenCountEl = document.getElementById('hiddenCount');
                    if (hiddenCountEl) {
                        hiddenCountEl.textContent = progress.hidden;
                    }
                }
                
                // Only reload if:
                // 1. We've seen the process go through in_progress (not leftover state)
                // 2. AND projects were actually hidden (hidden > 0)
                // This prevents reloading when there are no projects to hide or when the process completes before hiding
                if (!hasSeenInProgress) {
                    // Don't reload - just stop polling
                    return;
                }
                
                if (progress.hidden === 0 || progress.hidden === undefined) {
                    // Show message that no projects were hidden
                    showToast('No projects matched your filter criteria to hide.', 'info');
                    // Don't reload - just stop polling
                    return;
                }
                
                // Reload page to show updated projects (only if projects were actually hidden)
                setTimeout(() => {
                    location.reload();
                }, 500);
            } else if (progress.status === 'error') {
                // Hide progress indicator
                if (progressEl) progressEl.style.display = 'none';
                stopProgressPolling();
                
                console.error('Error hiding projects:', progress.error || 'Unknown error');
                showToast('Error hiding projects: ' + (progress.error || 'Unknown error'), 'error');
            } else if (progress.status === 'idle') {
                // Hide progress indicator
                if (progressEl) progressEl.style.display = 'none';
                stopProgressPolling();
            }
        } catch (error) {
            console.error('Error checking hide progress:', error);
        }
    }
    
    // Hide project modal functions
    let currentHideProjectId = null;
    let currentHideProjectName = null;
    
    async function openHideModal(projectId, projectName) {
        currentHideProjectId = projectId;
        currentHideProjectName = projectName;
        document.getElementById('hideModal').style.display = 'flex';
        document.getElementById('hideFeedbackText').value = '';
        
        // Show loading state
        document.getElementById('hideProjectPreviewLoading').style.display = 'block';
        document.getElementById('hideProjectPreviewContent').style.display = 'none';
        document.getElementById('hideSuggestions').innerHTML = '';
        
        // Fetch project details and suggestions
        try {
            const response = await fetch('/api/hide-suggestions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ project_id: projectId })
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    displayProjectPreview(data.project);
                    displayHideSuggestions(data.suggestions);
                }
            } else {
                // If API fails, show basic info
                displayBasicProjectInfo(projectName);
            }
        } catch (error) {
            console.error('Error fetching project details:', error);
            displayBasicProjectInfo(projectName);
        }
    }
    
    function displayProjectPreview(project) {
        const previewContent = document.getElementById('hideProjectPreviewContent');
        const loadingEl = document.getElementById('hideProjectPreviewLoading');
        
        // Set project name
        document.getElementById('hideProjectName').textContent = project.name || 'Untitled Project';
        
        // Set incentive
        document.getElementById('hideProjectIncentive').textContent = `$${project.remuneration || 0}`;
        
        // Set time
        const timeMinutes = project.time_minutes || 0;
        const timeDisplay = timeMinutes >= 60 
            ? `${Math.floor(timeMinutes / 60)}h ${timeMinutes % 60}m`
            : `${timeMinutes}m`;
        document.getElementById('hideProjectTime').textContent = timeDisplay;
        
        // Calculate hourly rate
        const hourlyRate = timeMinutes > 0 ? ((project.remuneration || 0) / timeMinutes) * 60 : 0;
        document.getElementById('hideProjectHourlyRate').textContent = `$${hourlyRate.toFixed(2)}/hr`;
        
        // Set topics if available
        if (project.topics && project.topics.length > 0) {
            const topicsContainer = document.getElementById('hideProjectTopicsContainer');
            const topicsEl = document.getElementById('hideProjectTopics');
            topicsContainer.style.display = 'block';
            topicsEl.innerHTML = project.topics.map(topic => 
                `<span style="padding: 2px 6px; background: var(--bg-tertiary); border-radius: 4px; font-size: 12px;">${topic.name || topic}</span>`
            ).join('');
        } else {
            document.getElementById('hideProjectTopicsContainer').style.display = 'none';
        }
        
        // Set description
        const descEl = document.getElementById('hideProjectDescription');
        if (project.description) {
            descEl.textContent = project.description.length > 300 
                ? project.description.substring(0, 300) + '...'
                : project.description;
        } else {
            descEl.textContent = 'No description available';
        }
        
        loadingEl.style.display = 'none';
        previewContent.style.display = 'block';
    }
    
    function displayBasicProjectInfo(projectName) {
        const previewContent = document.getElementById('hideProjectPreviewContent');
        const loadingEl = document.getElementById('hideProjectPreviewLoading');
        
        document.getElementById('hideProjectName').textContent = projectName || 'Untitled Project';
        document.getElementById('hideProjectIncentive').textContent = 'Loading...';
        document.getElementById('hideProjectTime').textContent = 'Loading...';
        document.getElementById('hideProjectHourlyRate').textContent = 'Loading...';
        document.getElementById('hideProjectDescription').textContent = 'Loading project details...';
        
        loadingEl.style.display = 'none';
        previewContent.style.display = 'block';
    }
    
    function displayHideSuggestions(suggestions) {
        const suggestionsEl = document.getElementById('hideSuggestions');
        if (!suggestions || suggestions.length === 0) {
            suggestionsEl.innerHTML = '<p style="color: var(--text-secondary); font-size: 14px;">No suggestions available</p>';
            return;
        }
        
        suggestionsEl.innerHTML = suggestions.map(suggestion => `
            <button 
                type="button" 
                class="suggestion-chip" 
                onclick="selectSuggestion('${suggestion.replace(/'/g, "\\'")}')"
                style="padding: 6px 12px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; font-size: 13px; cursor: pointer; transition: all 0.2s; color: var(--text-primary);"
                onmouseover="this.style.background='var(--primary-color)'; this.style.color='white'; this.style.borderColor='var(--primary-color)'"
                onmouseout="this.style.background='var(--bg-tertiary)'; this.style.color='var(--text-primary)'; this.style.borderColor='var(--border-color)'"
            >
                ${suggestion}
            </button>
        `).join('');
    }
    
    function selectSuggestion(suggestion) {
        const feedbackText = document.getElementById('hideFeedbackText');
        feedbackText.value = suggestion;
        feedbackText.focus();
    }
    
    function closeHideModal() {
        document.getElementById('hideModal').style.display = 'none';
        currentHideProjectId = null;
        currentHideProjectName = null;
        // Reset preview state
        document.getElementById('hideProjectPreviewLoading').style.display = 'block';
        document.getElementById('hideProjectPreviewContent').style.display = 'none';
        document.getElementById('hideSuggestions').innerHTML = '';
        document.getElementById('hideFeedbackText').value = '';
    }
    
    async function hideProjectWithoutFeedback() {
        if (!currentHideProjectId) return;
        await hideProject(null);
    }
    
    async function hideProjectWithFeedback() {
        if (!currentHideProjectId) return;
        const feedback = document.getElementById('hideFeedbackText').value.trim();
        await hideProject(feedback);
    }
    
    async function hideProject(feedbackText) {
        if (!currentHideProjectId) return;
        
        // Store the project ID before making the request
        const projectIdToHide = currentHideProjectId;
        
        // Start visual feedback immediately - find and fade the card
        const card = findProjectCard(projectIdToHide);
        if (card) {
            card.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
            card.style.opacity = '0.5';
        }
        
        try {
            const response = await fetch('/api/hide-project', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    project_id: projectIdToHide,
                    feedback_text: feedbackText || null
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                // Restore card visibility on error
                if (card) {
                    card.style.opacity = '1';
                }
                throw new Error(error.error || 'Failed to hide project');
            }
            
            const result = await response.json();
            closeHideModal();
            
            // Remove project card from DOM without page reload
            removeProjectCard(projectIdToHide);
            
            // Update hidden count
            await updateHiddenCount();
            
            // If there's a question, show the question modal
            if (result.question) {
                showQuestionModal(result.question, projectIdToHide);
            } else {
                // Show notification
                if (result.auto_hidden_count > 0) {
                    showToast(`Project hidden! ${result.auto_hidden_count} similar project(s) were also automatically hidden.`, 'success');
                } else {
                    showToast('Project hidden successfully!', 'success');
                }
            }
        } catch (error) {
            console.error('Error hiding project:', error);
            showToast('Error hiding project: ' + error.message, 'error');
        }
    }
    
    // Helper function to find project card by ID
    function findProjectCard(projectId) {
        if (!projectId) return null;
        
        const projectIdStr = String(projectId);
        
        // Try multiple selector strategies
        let card = document.querySelector(`.project-card[data-project-id="${projectIdStr}"]`);
        
        if (!card) {
            card = document.querySelector(`.project-card[data-project-id='${projectIdStr}']`);
        }
        
        // If still not found, iterate through all cards
        if (!card) {
            const allCards = document.querySelectorAll('.project-card');
            for (let i = 0; i < allCards.length; i++) {
                const cardId = allCards[i].getAttribute('data-project-id');
                if (cardId === projectIdStr || cardId === projectId) {
                    card = allCards[i];
                    break;
                }
            }
        }
        
        return card;
    }
    
    // Question modal functions
    let currentQuestion = null;
    let currentQuestionProjectId = null;
    
    function showQuestionModal(question, projectId) {
        currentQuestion = question;
        currentQuestionProjectId = projectId;
        document.getElementById('questionText').textContent = question.text || question.question_text || '';
        document.getElementById('questionModal').style.display = 'flex';
    }
    
    function closeQuestionModal() {
        document.getElementById('questionModal').style.display = 'none';
        // Remove project card if it still exists
        if (currentQuestionProjectId) {
            removeProjectCard(currentQuestionProjectId);
        }
        currentQuestion = null;
        currentQuestionProjectId = null;
    }
    
    // Feedback Management Modal functions
    let editingFeedbackId = null;
    
    async function openFeedbackManagementModal() {
        document.getElementById('feedbackManagementModal').style.display = 'flex';
        await loadHideFeedback();
    }
    
    function closeFeedbackManagementModal() {
        document.getElementById('feedbackManagementModal').style.display = 'none';
        editingFeedbackId = null;
    }
    
    async function loadHideFeedback() {
        const loadingEl = document.getElementById('feedbackLoading');
        const contentEl = document.getElementById('feedbackContent');
        const listEl = document.getElementById('feedbackList');
        const emptyEl = document.getElementById('feedbackEmpty');
        
        loadingEl.style.display = 'block';
        contentEl.style.display = 'none';
        listEl.innerHTML = '';
        
        try {
            const response = await fetch('/api/hide-feedback', {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
            });
            
            if (!response.ok) {
                throw new Error('Failed to load feedback');
            }
            
            const data = await response.json();
            const feedbackList = data.feedback || [];
            
            loadingEl.style.display = 'none';
            contentEl.style.display = 'block';
            
            if (feedbackList.length === 0) {
                emptyEl.style.display = 'block';
                listEl.style.display = 'none';
            } else {
                emptyEl.style.display = 'none';
                listEl.style.display = 'flex';
                
                feedbackList.forEach(feedback => {
                    const feedbackCard = createFeedbackCard(feedback);
                    listEl.appendChild(feedbackCard);
                });
            }
        } catch (error) {
            console.error('Error loading feedback:', error);
            loadingEl.innerHTML = `<p style="color: var(--error-color);">Error loading feedback: ${error.message}</p>`;
        }
    }
    
    function createFeedbackCard(feedback) {
        const card = document.createElement('div');
        card.style.cssText = 'padding: 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px;';
        card.id = `feedback-${feedback.id}`;
        
        const isEditing = editingFeedbackId === feedback.id;
        
        if (isEditing) {
            card.innerHTML = `
                <textarea id="editFeedbackText-${feedback.id}" rows="2" style="width: 100%; padding: 6px; border: 1px solid var(--border-color); border-radius: 4px; font-family: inherit; resize: vertical; margin-bottom: 8px;">${escapeHtml(feedback.feedback_text || '')}</textarea>
                <div style="display: flex; gap: 6px;">
                    <button class="btn-primary" onclick="saveFeedbackEdit('${feedback.id}')" style="padding: 4px 10px; font-size: 0.85em;">Save</button>
                    <button class="btn-secondary" onclick="cancelFeedbackEdit('${feedback.id}')" style="padding: 4px 10px; font-size: 0.85em;">Cancel</button>
                </div>
            `;
        } else {
            card.innerHTML = `
                <div style="padding: 6px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; margin-bottom: 8px; font-size: 0.9em;">${escapeHtml(feedback.feedback_text || 'No feedback provided')}</div>
                <div style="display: flex; gap: 6px;">
                    <button class="btn-secondary" onclick="editFeedbackEntry('${feedback.id}')" style="padding: 4px 10px; font-size: 0.85em;">Edit</button>
                    <button class="btn-secondary" onclick="deleteFeedbackEntry('${feedback.id}')" style="padding: 4px 10px; font-size: 0.85em; color: var(--error-color); border-color: var(--error-color);">Delete</button>
                </div>
            `;
        }
        
        return card;
    }
    
    async function editFeedbackEntry(feedbackId) {
        editingFeedbackId = feedbackId;
        await loadHideFeedback();
    }
    
    async function saveFeedbackEdit(feedbackId) {
        const textarea = document.getElementById(`editFeedbackText-${feedbackId}`);
        const newText = textarea.value.trim();
        
        if (!newText) {
            showToast('Feedback text cannot be empty', 'error');
            return;
        }
        
        try {
            const response = await fetch(`/api/hide-feedback/${feedbackId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ feedback_text: newText })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to update feedback');
            }
            
            editingFeedbackId = null;
            await loadHideFeedback();
            showToast('Feedback updated successfully', 'success');
        } catch (error) {
            console.error('Error updating feedback:', error);
            showToast('Error updating feedback: ' + error.message, 'error');
        }
    }
    
    function cancelFeedbackEdit(feedbackId) {
        editingFeedbackId = null;
        loadHideFeedback();
    }
    
    async function deleteFeedbackEntry(feedbackId) {
        if (!confirm('Are you sure you want to delete this feedback entry? This may affect AI-based project hiding.')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/hide-feedback/${feedbackId}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' }
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to delete feedback');
            }
            
            await loadHideFeedback();
            showToast('Feedback deleted successfully', 'success');
        } catch (error) {
            console.error('Error deleting feedback:', error);
            showToast('Error deleting feedback: ' + error.message, 'error');
        }
    }
    
    function removeProjectCard(projectId) {
        if (!projectId) {
            console.warn('removeProjectCard called without projectId');
            return;
        }
        
        const card = findProjectCard(projectId);
        
        if (!card) {
            console.warn(`Project card with ID ${projectId} not found in DOM. Available cards:`, 
                Array.from(document.querySelectorAll('.project-card')).map(c => c.getAttribute('data-project-id')));
            return;
        }
        
        // Add fade-out animation
        card.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
        card.style.opacity = '0';
        card.style.transform = 'translateX(20px)';
        
        setTimeout(() => {
            if (card && card.parentNode) {
                card.remove();
                
                // Check if project list is now empty
                const projectList = document.querySelector('.project-list');
                if (projectList && projectList.children.length === 0) {
                    // Show empty state if no projects left
                    const projectsContainer = document.querySelector('.projects-container');
                    if (projectsContainer) {
                        projectsContainer.innerHTML = `
                            <div class="empty-state">
                                <svg class="empty-state-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                </svg>
                                <h3>No projects available</h3>
                                <p>All projects have been hidden or there are no matching projects.</p>
                            </div>
                        `;
                    }
                }
            }
        }, 300);
    }
    
    function skipQuestion() {
        closeQuestionModal();
    }
    
    async function answerQuestion(answer) {
        if (!currentQuestion) return;
        
        try {
            const response = await fetch('/api/answer-question', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    question_id: currentQuestion.id,
                    question_text: currentQuestion.text || currentQuestion.question_text,
                    answer: answer,
                    pattern: currentQuestion.pattern,
                    project_id: currentQuestionProjectId
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to submit answer');
            }
            
            const result = await response.json();
            
            // Remove project card if it still exists
            if (currentQuestionProjectId) {
                removeProjectCard(currentQuestionProjectId);
            }
            
            // Remove any auto-hidden projects from DOM
            if (result.auto_hidden_ids && result.auto_hidden_ids.length > 0) {
                result.auto_hidden_ids.forEach(projectId => {
                    removeProjectCard(projectId);
                });
            }
            
            closeQuestionModal();
            
            // Update hidden count
            await updateHiddenCount();
            
            // Show notification
            if (result.auto_hidden_count > 0) {
                showToast(`Thank you! ${result.auto_hidden_count} similar project(s) were automatically hidden based on your preference.`, 'success');
            } else {
                showToast('Thank you! Your preference has been saved.', 'success');
            }
        } catch (error) {
            console.error('Error answering question:', error);
            showToast('Error submitting answer: ' + error.message, 'error');
        }
    }
    
    // Close question modal when clicking outside
    document.getElementById('questionModal')?.addEventListener('click', function(e) {
        if (e.target === this) {
            closeQuestionModal();
        }
    });
    
    
    // Analytics functions
    async function updateHiddenCount() {
        try {
            const response = await fetch('/api/analytics/hidden-count');
            if (response.ok) {
                const data = await response.json();
                const hiddenCountEl = document.getElementById('hiddenCount');
                if (hiddenCountEl) {
                    hiddenCountEl.textContent = data.total_count || 0;
                }
            }
        } catch (error) {
            console.error('Error updating hidden count:', error);
        }
    }
    
    // Update total projects count
    async function updateTotalProjectsCount() {
        try {
            const response = await fetch('/api/cache/stats');
            if (response.ok) {
                const data = await response.json();
                const totalCountEl = document.getElementById('totalProjectsCount');
                const totalProjectsStat = totalCountEl?.closest('.footer-stat');
                if (totalCountEl && data.total_count !== undefined) {
                    totalCountEl.textContent = data.total_count || 0;
                    if (totalProjectsStat) {
                        totalProjectsStat.style.display = 'block';
                    }
                }
            }
        } catch (error) {
            console.error('Error updating total projects count:', error);
        }
    }
    
    // Load analytics on page load
    window.addEventListener('DOMContentLoaded', async () => {
        // Detect timezone first
        await detectTimezone();
        
        // Update cache refresh time and start countdown timer
        await updateCacheRefreshTime();
        
        await updateHiddenCount();
        await updateTotalProjectsCount();
        // Load analytics if section is visible
        // loadAnalytics();
    });
    
    
    // Close modals when clicking outside
    document.getElementById('hideModal')?.addEventListener('click', function(e) {
        if (e.target === this) closeHideModal();
    });
    
    document.getElementById('feedbackManagementModal')?.addEventListener('click', function(e) {
        if (e.target === this) closeFeedbackManagementModal();
    });
</script>
{% endblock %}
