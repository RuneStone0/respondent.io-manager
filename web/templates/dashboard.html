{% extends "base.html" %}

{% block title %}Dashboard - Respondent Pro{% endblock %}

{% block body %}
<div class="flex-1 min-h-screen flex flex-col p-6 max-w-6xl mx-auto w-full">
    {% include 'partials/header.html' %}
    
    <div class="bg-base-100 rounded-xl p-8 shadow-lg mt-6">
        <h1 class="text-2xl font-semibold text-base-content mb-6">Session Keys Configuration</h1>
        
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-lg font-semibold text-base-content">Status</h2>
            {% if config %}
            <span class="badge badge-success">Saved</span>
            {% else %}
            <span class="badge badge-warning">Not Saved</span>
            {% endif %}
        </div>
        
        <div class="alert alert-error hidden mb-4" id="error"></div>
        <div class="alert alert-success hidden mb-4" id="success"></div>
        
        <p class="text-sm text-base-content/70 mb-5">
            Provide your Respondent.io session keys to enable API access. You can find these in your browser's Developer Tools (F12) → Network tab when logged into respondent.io.
        </p>
        
        <form id="sessionKeysForm" class="space-y-4">
            <div class="form-control">
                <label class="label" for="session_sid">
                    <span class="label-text">respondent.session.sid *</span>
                </label>
                <input type="text" id="session_sid" placeholder="s%3AvDYrxyRM_m854jqPq90t05fkyVodoUc-..." name="session_sid" class="input input-bordered" required>
                <div class="label">
                    <span class="label-text-alt">The session cookie value from your browser</span>
                </div>
            </div>
            
            <div class="form-control">
                <label class="label" for="authorization">
                    <span class="label-text">Authorization Header</span>
                </label>
                <input type="text" id="authorization" placeholder="Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." name="authorization" class="input input-bordered">
                <div class="label">
                    <span class="label-text-alt">The Authorization Bearer token from request headers (optional)</span>
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary w-full" id="saveBtn">Save Session Keys</button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Override showError/showSuccess for DaisyUI alerts
    function showError(message) {
        const errorDiv = document.getElementById('error');
        if (errorDiv) {
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            errorDiv.classList.add('alert-error');
            const successDiv = document.getElementById('success');
            if (successDiv) {
                successDiv.classList.add('hidden');
            }
        }
    }
    
    function showSuccess(message) {
        const successDiv = document.getElementById('success');
        if (successDiv) {
            successDiv.textContent = message;
            successDiv.classList.remove('hidden');
            successDiv.classList.add('alert-success');
            const errorDiv = document.getElementById('error');
            if (errorDiv) {
                errorDiv.classList.add('hidden');
            }
        }
    }
    
    function hideMessage() {
        const errorDiv = document.getElementById('error');
        const successDiv = document.getElementById('success');
        if (errorDiv) errorDiv.classList.add('hidden');
        if (successDiv) successDiv.classList.add('hidden');
    }
    
    // Load existing config if available
    {% if config %}
    window.addEventListener('DOMContentLoaded', () => {
        const config = {{ config | tojson }};
        
        if (config.cookies && config.cookies['respondent.session.sid']) {
            document.getElementById('session_sid').value = config.cookies['respondent.session.sid'];
        }
        
        if (config.authorization) {
            document.getElementById('authorization').value = config.authorization;
        }
    });
    {% endif %}
    
    document.getElementById('sessionKeysForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        hideMessage();
        
        const session_sid = document.getElementById('session_sid').value.trim();
        const authorization = document.getElementById('authorization').value.trim() || null;
        
        if (!session_sid) {
            showError('respondent.session.sid is required');
            return;
        }
        
        const saveBtn = document.getElementById('saveBtn');
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';
        
        try {
            const response = await fetch('/api/session-keys', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    session_sid,
                    authorization
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to save session keys');
            }
            
            const result = await response.json();
            
            // Display verification results
            if (result.verification) {
                const verification = result.verification;
                if (verification.success) {
                    showSuccess(
                        `✅ ${result.message}\n` +
                        `✅ Authentication verified!\n` +
                        `Profile ID: ${verification.profile_id}\n` +
                        `First Name: ${verification.first_name}`
                    );
                } else {
                    showError(
                        `Session keys saved, but verification failed:\n${verification.message}`
                    );
                }
            } else {
                showSuccess(result.message || 'Session keys saved successfully!');
            }
            
            // Update status badge
            const badge = document.querySelector('.badge');
            if (badge) {
                badge.textContent = 'Saved';
                badge.className = 'badge badge-success';
            }
            
        } catch (error) {
            showError(error.message || 'Failed to save session keys');
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save Session Keys';
        }
    });
</script>
{% endblock %}
