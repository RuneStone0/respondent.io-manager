{% extends "base.html" %}

{% block title %}Dashboard - Respondent Pro{% endblock %}

{% block body %}
<div class="container">
    <div class="header">
        <h1>Respondent Pro</h1>
        <div class="user-info">
            <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle dark mode">
                <svg id="theme-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.166a.75.75 0 00-1.06-1.06l-1.591 1.59a.75.75 0 101.06 1.061l1.591-1.59zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5H21a.75.75 0 01.75.75zM17.834 18.894a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 10-1.061 1.06l1.59 1.591zM12 18a.75.75 0 01.75.75V21a.75.75 0 01-1.5 0v-2.25A.75.75 0 0112 18zM7.758 17.303a.75.75 0 00-1.061-1.06l-1.591 1.59a.75.75 0 001.06 1.061l1.591-1.59zM6 12a.75.75 0 01-.75.75H3a.75.75 0 010-1.5h2.25A.75.75 0 016 12zM6.697 7.757a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 00-1.061 1.06l1.59 1.591z"/>
                </svg>
            </button>
            <span class="username">Logged in as: <strong>{{ email }}</strong></span>
            <a href="/logout" class="btn-logout">Logout</a>
        </div>
    </div>
    
    <nav class="nav-menu">
        <ul>
            <li><a href="/dashboard" class="active">Dashboard</a></li>
            <li><a href="/projects">Projects</a></li>
        </ul>
    </nav>
    
    <div class="card">
        <h2>
            Session Keys
            {% if config %}
            <span class="status-badge saved">Saved</span>
            {% else %}
            <span class="status-badge not-saved">Not Saved</span>
            {% endif %}
        </h2>
        
        <div class="error" id="error"></div>
        <div class="success" id="success"></div>
        
        <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 14px;">
            Provide your Respondent.io session keys to enable API access. You can find these in your browser's Developer Tools (F12) → Network tab when logged into respondent.io.
        </p>
        
        <form id="sessionKeysForm">
            <div class="form-group">
                <label for="session_sid">respondent.session.sid *</label>
                <input type="text" id="session_sid" placeholder="s%3AvDYrxyRM_m854jqPq90t05fkyVodoUc-..." name="session_sid" required>
                <div class="help-text">The session cookie value from your browser</div>
            </div>
            
            <div class="form-group">
                <label for="authorization">Authorization Header</label>
                <input type="text" id="authorization" placeholder="Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." name="authorization">
                <div class="help-text">The Authorization Bearer token from request headers (optional)</div>
            </div>
            
            <button type="submit" class="btn-primary" id="saveBtn">Save Session Keys</button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Load existing config if available
    {% if config %}
    window.addEventListener('DOMContentLoaded', () => {
        const config = {{ config | tojson }};
        
        if (config.cookies && config.cookies['respondent.session.sid']) {
            document.getElementById('session_sid').value = config.cookies['respondent.session.sid'];
        }
        
        if (config.authorization) {
            document.getElementById('authorization').value = config.authorization;
        }
    });
    {% endif %}
    
    document.getElementById('sessionKeysForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        hideMessage();
        
        const session_sid = document.getElementById('session_sid').value.trim();
        const authorization = document.getElementById('authorization').value.trim() || null;
        
        if (!session_sid) {
            showError('respondent.session.sid is required');
            return;
        }
        
        const saveBtn = document.getElementById('saveBtn');
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';
        
        try {
            const response = await fetch('/api/session-keys', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    session_sid,
                    authorization
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to save session keys');
            }
            
            const result = await response.json();
            
            // Display verification results
            if (result.verification) {
                const verification = result.verification;
                if (verification.success) {
                    showSuccess(
                        `✅ ${result.message}\n` +
                        `✅ Authentication verified!\n` +
                        `Profile ID: ${verification.profile_id}\n` +
                        `First Name: ${verification.first_name}`
                    );
                } else {
                    showError(
                        `Session keys saved, but verification failed:\n${verification.message}`
                    );
                }
            } else {
                showSuccess(result.message || 'Session keys saved successfully!');
            }
            
            // Update status badge
            const badge = document.querySelector('.status-badge');
            badge.textContent = 'Saved';
            badge.className = 'status-badge saved';
            
        } catch (error) {
            showError(error.message || 'Failed to save session keys');
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save Session Keys';
        }
    });
</script>
{% endblock %}
