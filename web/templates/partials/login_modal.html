<!-- Login Modal (DaisyUI) -->
<dialog id="loginModal" class="modal">
    <div class="modal-box">
        <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="closeLoginModal()">✕</button>
        </form>
        <h3 class="font-bold text-lg mb-4" id="modalTitle">Login</h3>
        <div class="error hidden" id="error"></div>
        <div class="success hidden" id="success"></div>
        
        <!-- Login Form -->
        <div id="loginForm">
            <div class="w-full mb-3">
                <input type="email" id="loginEmail" placeholder="Enter your email" autocomplete="email" class="input input-bordered w-full">
            </div>
            <div class="w-full mb-3">
                <input type="password" id="loginPassword" placeholder="Enter your password" autocomplete="current-password" class="input input-bordered w-full">
            </div>
            <div class="flex gap-2.5 mt-4 w-full">
                <button class="btn btn-primary flex-1" id="loginBtn">
                    <span class="btn-text">Login</span>
                </button>
            </div>
            <div class="text-center mt-3">
                <button type="button" class="link link-primary text-sm" onclick="switchToEmailLink()">Use email link instead</button>
            </div>
            <div class="text-center mt-2">
                <button type="button" class="link link-primary text-sm" onclick="switchToRegister()">Don't have an account? Sign up</button>
            </div>
        </div>
        
        <!-- Email Link Form -->
        <div id="emailLinkForm" class="hidden">
            <div class="w-full mb-5">
                <input type="email" id="emailLinkEmail" placeholder="Enter your email" autocomplete="email" class="input input-bordered w-full">
            </div>
            <div class="flex gap-2.5 mt-4 w-full">
                <button class="btn btn-primary flex-1" id="emailLinkBtn">
                    <span class="btn-text">Send Login Link</span>
                </button>
            </div>
            <div class="text-center mt-3">
                <button type="button" class="link link-primary text-sm" onclick="switchToLogin()">Back to password login</button>
            </div>
        </div>
        
        <!-- Register Form -->
        <div id="registerForm" class="hidden">
            <div class="w-full mb-3">
                <input type="email" id="registerEmail" placeholder="Enter your email" autocomplete="email" class="input input-bordered w-full">
            </div>
            <div class="w-full mb-3">
                <input type="password" id="registerPassword" placeholder="Create a password" autocomplete="new-password" class="input input-bordered w-full">
            </div>
            <div class="w-full mb-3">
                <input type="password" id="registerPasswordConfirm" placeholder="Confirm password" autocomplete="new-password" class="input input-bordered w-full">
            </div>
            <div class="flex gap-2.5 mt-4 w-full">
                <button class="btn btn-primary flex-1" id="registerBtn">
                    <span class="btn-text">Sign Up</span>
                </button>
            </div>
            <div class="text-center mt-3">
                <button type="button" class="link link-primary text-sm" onclick="switchToLogin()">Already have an account? Login</button>
            </div>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button onclick="closeLoginModal()">close</button>
    </form>
</dialog>

<script>
(function() {
    let currentMode = 'login'; // 'login', 'emailLink', 'register'
    
    // Open login modal
    window.openLoginModal = function() {
        const modal = document.getElementById('loginModal');
        if (modal) {
            modal.showModal();
            switchToLogin();
            setTimeout(() => {
                const emailInput = document.getElementById('loginEmail');
                if (emailInput) {
                    emailInput.focus();
                }
            }, 100);
        }
    };
    
    // Close login modal
    window.closeLoginModal = function() {
        const modal = document.getElementById('loginModal');
        if (modal) {
            modal.close();
            resetForms();
            hideMessage();
        }
    };
    
    function resetForms() {
        // Reset all inputs
        document.getElementById('loginEmail').value = '';
        document.getElementById('loginPassword').value = '';
        document.getElementById('emailLinkEmail').value = '';
        document.getElementById('registerEmail').value = '';
        document.getElementById('registerPassword').value = '';
        document.getElementById('registerPasswordConfirm').value = '';
        currentMode = 'login';
    }
    
    function switchToLogin() {
        currentMode = 'login';
        document.getElementById('modalTitle').textContent = 'Login';
        document.getElementById('loginForm').classList.remove('hidden');
        document.getElementById('emailLinkForm').classList.add('hidden');
        document.getElementById('registerForm').classList.add('hidden');
        hideMessage();
    }
    
    function switchToEmailLink() {
        currentMode = 'emailLink';
        document.getElementById('modalTitle').textContent = 'Email Login Link';
        document.getElementById('loginForm').classList.add('hidden');
        document.getElementById('emailLinkForm').classList.remove('hidden');
        document.getElementById('registerForm').classList.add('hidden');
        hideMessage();
    }
    
    function switchToRegister() {
        currentMode = 'register';
        document.getElementById('modalTitle').textContent = 'Sign Up';
        document.getElementById('loginForm').classList.add('hidden');
        document.getElementById('emailLinkForm').classList.add('hidden');
        document.getElementById('registerForm').classList.remove('hidden');
        hideMessage();
    }
    
    window.switchToLogin = switchToLogin;
    window.switchToEmailLink = switchToEmailLink;
    window.switchToRegister = switchToRegister;
    
    function validateEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }
    
    function setButtonLoading(button, isLoading, text = null) {
        if (!button) return;
        
        if (isLoading) {
            button.disabled = true;
            button.classList.add('btn-loading');
            const btnText = button.querySelector('.btn-text');
            if (btnText) {
                if (text) {
                    btnText.textContent = text;
                }
                if (!button.querySelector('.btn-spinner')) {
                    const spinner = document.createElement('span');
                    spinner.className = 'btn-spinner';
                    button.insertBefore(spinner, btnText);
                }
            }
        } else {
            button.disabled = false;
            button.classList.remove('btn-loading');
            const spinner = button.querySelector('.btn-spinner');
            if (spinner) {
                spinner.remove();
            }
        }
    }
    
    function showError(message) {
        const errorDiv = document.getElementById('error');
        if (errorDiv) {
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }
        const successDiv = document.getElementById('success');
        if (successDiv) {
            successDiv.classList.add('hidden');
        }
    }
    
    function showSuccess(message) {
        const successDiv = document.getElementById('success');
        if (successDiv) {
            successDiv.textContent = message;
            successDiv.classList.remove('hidden');
        }
        const errorDiv = document.getElementById('error');
        if (errorDiv) {
            errorDiv.classList.add('hidden');
        }
    }
    
    function hideMessage() {
        const errorDiv = document.getElementById('error');
        if (errorDiv) {
            errorDiv.classList.add('hidden');
        }
        const successDiv = document.getElementById('success');
        if (successDiv) {
            successDiv.classList.add('hidden');
        }
    }
    
    async function handleLogin() {
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value;
        
        if (!email) {
            showError('Please enter your email address');
            return;
        }
        if (!validateEmail(email)) {
            showError('Please enter a valid email address');
            return;
        }
        if (!password) {
            showError('Please enter your password');
            return;
        }
        
        hideMessage();
        const loginBtn = document.getElementById('loginBtn');
        setButtonLoading(loginBtn, true, 'Logging in...');
        
        try {
            if (!window.firebaseAuth || !window.firebaseAuth.signIn) {
                throw new Error('Firebase Auth not initialized. Please refresh the page.');
            }
            
            await window.firebaseAuth.signIn(email, password);
            
            // Success - redirect to dashboard
            setButtonLoading(loginBtn, true, 'Redirecting...');
            setTimeout(() => {
                window.location.href = '/dashboard';
            }, 500);
        } catch (error) {
            console.error('Login error:', error);
            let errorMessage = 'Login failed. Please try again.';
            
            if (error.code === 'auth/user-not-found') {
                errorMessage = 'No account found with this email. Please sign up first.';
            } else if (error.code === 'auth/wrong-password') {
                errorMessage = 'Incorrect password. Please try again.';
            } else if (error.code === 'auth/invalid-email') {
                errorMessage = 'Invalid email address.';
            } else if (error.code === 'auth/user-disabled') {
                errorMessage = 'This account has been disabled.';
            } else if (error.message) {
                errorMessage = error.message;
            }
            
            showError(errorMessage);
        } finally {
            setButtonLoading(loginBtn, false);
        }
    }
    
    async function handleEmailLink() {
        const email = document.getElementById('emailLinkEmail').value.trim();
        
        if (!email) {
            showError('Please enter your email address');
            return;
        }
        if (!validateEmail(email)) {
            showError('Please enter a valid email address');
            return;
        }
        
        hideMessage();
        const emailLinkBtn = document.getElementById('emailLinkBtn');
        setButtonLoading(emailLinkBtn, true, 'Sending login link...');
        
        try {
            if (!window.firebaseAuth || !window.firebaseAuth.signInWithLink) {
                throw new Error('Firebase Auth not initialized. Please refresh the page.');
            }
            
            // Use Firebase Auth email link sign-in
            await window.firebaseAuth.signInWithLink(email);
            showSuccess('Login link sent! Please check your email and click the link to log in.');
            document.getElementById('emailLinkEmail').value = '';
        } catch (error) {
            console.error('Email link error:', error);
            let errorMessage = 'Failed to send login link. Please try again.';
            
            if (error.code === 'auth/invalid-email') {
                errorMessage = 'Invalid email address.';
            } else if (error.code === 'auth/user-disabled') {
                errorMessage = 'This account has been disabled.';
            } else if (error.code === 'auth/operation-not-allowed') {
                errorMessage = 'Email link sign-in is not enabled in Firebase Console. ' +
                    'Please enable "Email link (passwordless sign-in)" in Firebase Console → Authentication → Sign-in method.';
            } else if (error.code === 'auth/quota-exceeded') {
                errorMessage = 'Email sending quota exceeded. Please try again later.';
            } else if (error.message) {
                errorMessage = error.message;
            }
            
            showError(errorMessage);
        } finally {
            setButtonLoading(emailLinkBtn, false);
        }
    }
    
    async function handleRegister() {
        const email = document.getElementById('registerEmail').value.trim();
        const password = document.getElementById('registerPassword').value;
        const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
        
        if (!email) {
            showError('Please enter your email address');
            return;
        }
        if (!validateEmail(email)) {
            showError('Please enter a valid email address');
            return;
        }
        if (!password) {
            showError('Please enter a password');
            return;
        }
        if (password.length < 6) {
            showError('Password must be at least 6 characters long');
            return;
        }
        if (password !== passwordConfirm) {
            showError('Passwords do not match');
            return;
        }
        
        hideMessage();
        const registerBtn = document.getElementById('registerBtn');
        setButtonLoading(registerBtn, true, 'Creating account...');
        
        try {
            if (!window.firebaseAuth || !window.firebaseAuth.signUp) {
                throw new Error('Firebase Auth not initialized. Please refresh the page.');
            }
            
            const userCredential = await window.firebaseAuth.signUp(email, password);
            
            // User is automatically signed in after signup
            // Ensure cookie is set (signUp function should have set it, but double-check)
            const idToken = await userCredential.user.getIdToken();
            // Add Secure flag in production (HTTPS), but not in local development (HTTP)
            // Use SameSite=None; Secure in production for maximum compatibility
            const isSecure = window.location.protocol === 'https:';
            const cookieOptions = isSecure 
                ? 'path=/; max-age=3600; SameSite=None; Secure'
                : 'path=/; max-age=3600; SameSite=Lax';
            document.cookie = `firebase_id_token=${idToken}; ${cookieOptions}`;
            
            // Wait a moment for auth state to propagate
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Check if email is verified
            if (userCredential.user.emailVerified) {
                showSuccess('Account created! Redirecting...');
                setTimeout(() => {
                    window.location.href = '/dashboard';
                }, 1000);
            } else {
                showSuccess('Account created! Please check your email to verify your account. You can still access the app, but some features require verification.');
                setTimeout(() => {
                    window.location.href = '/dashboard';
                }, 2000);
            }
        } catch (error) {
            console.error('Registration error:', error);
            let errorMessage = 'Registration failed. Please try again.';
            
            if (error.code === 'auth/email-already-in-use') {
                errorMessage = 'This email is already registered. Please login instead.';
            } else if (error.code === 'auth/invalid-email') {
                errorMessage = 'Invalid email address.';
            } else if (error.code === 'auth/weak-password') {
                errorMessage = 'Password is too weak. Please choose a stronger password.';
            } else if (error.message) {
                errorMessage = error.message;
            }
            
            showError(errorMessage);
        } finally {
            setButtonLoading(registerBtn, false);
        }
    }
    
    // Initialize on DOM ready
    document.addEventListener('DOMContentLoaded', () => {
        // Login form
        const loginEmail = document.getElementById('loginEmail');
        const loginPassword = document.getElementById('loginPassword');
        const loginBtn = document.getElementById('loginBtn');
        
        if (loginEmail) {
            loginEmail.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
        }
        if (loginPassword) {
            loginPassword.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
        }
        if (loginBtn) {
            loginBtn.addEventListener('click', handleLogin);
        }
        
        // Email link form
        const emailLinkEmail = document.getElementById('emailLinkEmail');
        const emailLinkBtn = document.getElementById('emailLinkBtn');
        
        if (emailLinkEmail) {
            emailLinkEmail.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleEmailLink();
            });
        }
        if (emailLinkBtn) {
            emailLinkBtn.addEventListener('click', handleEmailLink);
        }
        
        // Register form
        const registerEmail = document.getElementById('registerEmail');
        const registerPassword = document.getElementById('registerPassword');
        const registerPasswordConfirm = document.getElementById('registerPasswordConfirm');
        const registerBtn = document.getElementById('registerBtn');
        
        if (registerEmail) {
            registerEmail.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleRegister();
            });
        }
        if (registerPassword) {
            registerPassword.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleRegister();
            });
        }
        if (registerPasswordConfirm) {
            registerPasswordConfirm.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleRegister();
            });
        }
        if (registerBtn) {
            registerBtn.addEventListener('click', handleRegister);
        }
        
        // Check for email link in URL (for email link authentication)
        if (window.location.href.includes('emailLinkSignIn')) {
            const urlParams = new URLSearchParams(window.location.search);
            const emailLink = urlParams.get('link');
            const email = localStorage.getItem('emailForSignIn');
            
            if (emailLink && email && window.firebaseAuth && window.firebaseAuth.signInWithLinkComplete) {
                window.firebaseAuth.signInWithLinkComplete(email, window.location.href)
                    .then(() => {
                        window.location.href = '/dashboard';
                    })
                    .catch((error) => {
                        console.error('Email link sign-in error:', error);
                        showError('Invalid or expired login link. Please request a new one.');
                    });
            }
        }
    });
})();
</script>

<style>
.btn-loading {
    position: relative;
    pointer-events: none;
    opacity: 0.7;
}
.btn-loading .btn-spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid currentColor;
    border-top-color: transparent;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-right: 8px;
    vertical-align: middle;
}
@keyframes spin {
    to { transform: rotate(360deg); }
}
.error {
    @apply bg-error text-error-content p-3 rounded-lg mb-4;
}
.success {
    @apply bg-success text-success-content p-3 rounded-lg mb-4;
}
</style>
